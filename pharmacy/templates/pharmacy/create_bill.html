{% extends 'base.html' %}
{% load static %}

{% block title %}Create Bill - Pharmacy{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Create New Bill</h1>
                        <p class="text-gray-600">Generate a new customer bill</p>
                    </div>
                    <a href="{% url 'pharmacy:bill_list' %}" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Bills
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <form method="post" id="billForm">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Bill Information -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Bill Information</h3>
                        </div>
                        <div class="p-6 space-y-6">
                            <!-- Customer Selection -->
                            <div>
                                <label for="customer" class="block text-sm font-medium text-gray-700">Customer</label>
                                <select name="customer" id="customer" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Select Customer</option>
                                    {% for customer in form.customer.field.queryset %}
                                        <option value="{{ customer.id }}">{{ customer.full_name }} ({{ customer.customer_id }})</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Prescription Selection -->
                            <div>
                                <label for="prescription" class="block text-sm font-medium text-gray-700">Prescription (Optional)</label>
                                <select name="prescription" id="prescription" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">No Prescription</option>
                                </select>
                            </div>

                            <!-- Discount and Tax -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="discount_percentage" class="block text-sm font-medium text-gray-700">Discount (%)</label>
                                    <input type="number" name="discount_percentage" id="discount_percentage" step="0.01" min="0" max="100" value="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="tax_percentage" class="block text-sm font-medium text-gray-700">Tax (%)</label>
                                    <input type="number" name="tax_percentage" id="tax_percentage" step="0.01" min="0" max="100" value="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>

                            <!-- Payment Method -->
                            <div>
                                <label for="payment_method" class="block text-sm font-medium text-gray-700">Payment Method</label>
                                <select name="payment_method" id="payment_method" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="cash">Cash</option>
                                    <option value="card">Card</option>
                                    <option value="upi">UPI</option>
                                    <option value="netbanking">Net Banking</option>
                                    <option value="cheque">Cheque</option>
                                </select>
                            </div>

                            <!-- Notes -->
                            <div>
                                <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                                <textarea name="notes" id="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Medicine Selection -->
                    <div class="mt-8 bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Add Medicines</h3>
                        </div>
                        <div class="p-6">
                            <!-- Add Medicine Form -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label for="medicine_search" class="block text-sm font-medium text-gray-700">Search Medicine</label>
                                    <input type="text" id="medicine_search" placeholder="Search medicines..." class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="medicine_select" class="block text-sm font-medium text-gray-700">Medicine</label>
                                    <select id="medicine_select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select Medicine</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                    <input type="number" id="quantity" min="1" value="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="flex items-end">
                                    <button type="button" id="add_medicine" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-plus mr-2"></i>Add
                                    </button>
                                </div>
                            </div>

                            <!-- Medicine List -->
                            <div id="medicine_list" class="space-y-2">
                                <!-- Medicines will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bill Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow sticky top-4">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Bill Summary</h3>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Subtotal:</span>
                                    <span class="text-sm font-medium" id="subtotal">₹0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Discount:</span>
                                    <span class="text-sm font-medium" id="discount_amount">₹0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Tax:</span>
                                    <span class="text-sm font-medium" id="tax_amount">₹0.00</span>
                                </div>
                                <div class="border-t pt-4">
                                    <div class="flex justify-between">
                                        <span class="text-lg font-semibold text-gray-900">Total:</span>
                                        <span class="text-lg font-semibold text-gray-900" id="total_amount">₹0.00</span>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6">
                                <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                                    <i class="fas fa-save mr-2"></i>Create Bill
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Hidden input for items -->
<input type="hidden" name="items" id="items_input" value="[]">

<script>
document.addEventListener('DOMContentLoaded', function() {
    const medicineSearch = document.getElementById('medicine_search');
    const medicineSelect = document.getElementById('medicine_select');
    const quantityInput = document.getElementById('quantity');
    const addMedicineBtn = document.getElementById('add_medicine');
    const medicineList = document.getElementById('medicine_list');
    const itemsInput = document.getElementById('items_input');
    
    let selectedMedicines = [];
    let billItems = [];

    // Medicine search functionality
    medicineSearch.addEventListener('input', function() {
        const query = this.value;
        if (query.length > 2) {
            fetch(`/pharmacy/api/medicines/search/?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    medicineSelect.innerHTML = '<option value="">Select Medicine</option>';
                    data.forEach(medicine => {
                        const option = document.createElement('option');
                        option.value = medicine.id;
                        option.textContent = `${medicine.name} (${medicine.strength}) - Stock: ${medicine.stock_quantity}`;
                        option.dataset.price = medicine.selling_price;
                        option.dataset.stock = medicine.stock_quantity;
                        medicineSelect.appendChild(option);
                    });
                });
        }
    });

    // Add medicine to bill
    addMedicineBtn.addEventListener('click', function() {
        const medicineId = medicineSelect.value;
        const quantity = parseInt(quantityInput.value);
        
        if (!medicineId || quantity <= 0) {
            alert('Please select a medicine and enter quantity');
            return;
        }

        const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];
        const price = parseFloat(selectedOption.dataset.price);
        const stock = parseInt(selectedOption.dataset.stock);
        
        if (quantity > stock) {
            alert('Insufficient stock available');
            return;
        }

        // Check if medicine already added
        if (selectedMedicines.includes(medicineId)) {
            alert('Medicine already added to bill');
            return;
        }

        const totalPrice = price * quantity;
        
        // Add to bill items
        const billItem = {
            medicine_id: medicineId,
            name: selectedOption.textContent.split(' - ')[0],
            quantity: quantity,
            unit_price: price,
            total_price: totalPrice
        };
        
        billItems.push(billItem);
        selectedMedicines.push(medicineId);
        
        // Update items input
        itemsInput.value = JSON.stringify(billItems);
        
        // Add to UI
        const medicineItem = document.createElement('div');
        medicineItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        medicineItem.innerHTML = `
            <div>
                <p class="font-medium text-gray-900">${billItem.name}</p>
                <p class="text-sm text-gray-500">Qty: ${quantity} × ₹${price}</p>
            </div>
            <div class="flex items-center space-x-2">
                <span class="font-semibold text-gray-900">₹${totalPrice.toFixed(2)}</span>
                <button type="button" class="text-red-600 hover:text-red-800" onclick="removeMedicine('${medicineId}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        medicineList.appendChild(medicineItem);
        
        // Clear form
        medicineSelect.value = '';
        quantityInput.value = '1';
        
        // Update summary
        updateBillSummary();
    });

    // Remove medicine function
    window.removeMedicine = function(medicineId) {
        billItems = billItems.filter(item => item.medicine_id !== medicineId);
        selectedMedicines = selectedMedicines.filter(id => id !== medicineId);
        itemsInput.value = JSON.stringify(billItems);
        
        // Remove from UI
        const medicineItems = medicineList.querySelectorAll('[data-medicine-id]');
        medicineItems.forEach(item => {
            if (item.dataset.medicineId === medicineId) {
                item.remove();
            }
        });
        
        updateBillSummary();
    };

    // Update bill summary
    function updateBillSummary() {
        const subtotal = billItems.reduce((sum, item) => sum + item.total_price, 0);
        const discountPercentage = parseFloat(document.getElementById('discount_percentage').value) || 0;
        const taxPercentage = parseFloat(document.getElementById('tax_percentage').value) || 0;
        
        const discountAmount = (subtotal * discountPercentage) / 100;
        const taxableAmount = subtotal - discountAmount;
        const taxAmount = (taxableAmount * taxPercentage) / 100;
        const total = taxableAmount + taxAmount;
        
        document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
        document.getElementById('discount_amount').textContent = `₹${discountAmount.toFixed(2)}`;
        document.getElementById('tax_amount').textContent = `₹${taxAmount.toFixed(2)}`;
        document.getElementById('total_amount').textContent = `₹${total.toFixed(2)}`;
    }

    // Update summary when discount or tax changes
    document.getElementById('discount_percentage').addEventListener('input', updateBillSummary);
    document.getElementById('tax_percentage').addEventListener('input', updateBillSummary);
});
</script>
{% endblock %}
