{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Mediwell Care{% endblock %}

{% block extra_css %}
<style>
    /* Ultra-Modern Analytics Dashboard */
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        --info-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --dark-bg: #0f172a;
        --card-bg: rgba(255, 255, 255, 0.95);
        --glass-bg: rgba(255, 255, 255, 0.1);
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-color: rgba(255, 255, 255, 0.2);
        --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --shadow-large: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--dark-bg);
        color: var(--text-primary);
        line-height: 1.6;
    }

    .analytics-container {
        background: var(--dark-bg);
        min-height: 100vh;
        padding: 0;
        position: relative;
        overflow-x: hidden;
    }

    .analytics-container::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
        pointer-events: none;
        z-index: 0;
    }

    .dashboard-header {
        background: var(--primary-gradient);
        color: white;
        padding: 4rem 0;
        margin-bottom: 4rem;
        box-shadow: var(--shadow-large);
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }

    .metric-card {
        background: var(--card-bg);
        border-radius: 24px;
        padding: 3rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-large);
        border: 1px solid var(--border-color);
        backdrop-filter: blur(20px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        transform: translateY(0);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .metric-card:hover {
        transform: translateY(-12px);
        box-shadow: 0 32px 64px -12px rgba(0, 0, 0, 0.4);
    }

    .metric-card:hover::before {
        transform: scaleX(1);
    }

    .metric-icon {
        font-size: 3.5rem;
        margin-bottom: 1.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        display: block;
        text-align: center;
    }

    .metric-value {
        font-size: 4.5rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        line-height: 1;
    }

    .metric-label {
        font-size: 1.3rem;
        color: var(--text-secondary);
        font-weight: 600;
        margin-bottom: 1.5rem;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .metric-trend {
        font-size: 1rem;
        font-weight: 700;
        padding: 1rem 2rem;
        border-radius: 25px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .trend-up {
        background: var(--success-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .trend-down {
        background: var(--secondary-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
    }

    .chart-container {
        background: var(--card-bg);
        border-radius: 24px;
        padding: 3rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-large);
        border: 1px solid var(--border-color);
        backdrop-filter: blur(20px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .chart-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .chart-container:hover {
        transform: translateY(-8px);
        box-shadow: 0 32px 64px -12px rgba(0, 0, 0, 0.4);
    }

    .chart-container:hover::before {
        transform: scaleX(1);
    }

    .chart-header {
        display: flex;
        align-items: center;
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-color);
        position: relative;
    }

    .chart-icon {
        font-size: 2.5rem;
        margin-right: 1rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .chart-title {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .table-container {
        background: var(--card-bg);
        border-radius: 24px;
        padding: 3rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-large);
        border: 1px solid var(--border-color);
        backdrop-filter: blur(20px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .table-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .table-container:hover {
        transform: translateY(-8px);
        box-shadow: 0 32px 64px -12px rgba(0, 0, 0, 0.4);
    }

    .table-container:hover::before {
        transform: scaleX(1);
    }

    .table-header {
        display: flex;
        align-items: center;
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-color);
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .table {
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
    }

    .table th {
        border: none;
        background: var(--glass-bg);
        color: var(--text-primary);
        font-weight: 700;
        padding: 1.5rem 1rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 2px solid var(--border-color);
    }

    .table td {
        border: none;
        padding: 1.5rem 1rem;
        vertical-align: middle;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .table tbody tr {
        transition: all 0.3s ease;
    }

    .table tbody tr:hover {
        background: var(--glass-bg);
        transform: translateX(8px);
    }

    .table tbody tr:hover td {
        color: var(--text-primary);
        font-weight: 600;
    }

    .badge {
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-weight: 700;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: var(--shadow-light);
    }

    .badge-primary {
        background: var(--primary-gradient);
        color: white;
    }

    .badge-success {
        background: var(--success-gradient);
        color: white;
    }

    .badge-warning {
        background: var(--warning-gradient);
        color: white;
    }

    .badge-info {
        background: var(--info-gradient);
        color: white;
    }

    .progress {
        height: 12px;
        border-radius: 15px;
        background: var(--glass-bg);
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
        background: var(--primary-gradient);
        border-radius: 15px;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .real-time-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        background: var(--success-gradient);
        border-radius: 50%;
        animation: pulse 2s infinite;
        margin-right: 0.75rem;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }

    .form-control-modern {
        background: var(--glass-bg);
        border: 2px solid var(--border-color);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        color: var(--text-primary);
        backdrop-filter: blur(10px);
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .form-control-modern:focus {
        background: var(--card-bg);
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
    }

    .btn-modern {
        background: var(--primary-gradient);
        border: none;
        border-radius: 15px;
        padding: 1rem 2rem;
        color: white;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-medium);
    }

    .btn-modern:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-large);
        color: white;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 3rem;
        margin-bottom: 4rem;
    }

    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 3rem;
        margin-bottom: 4rem;
    }

    .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
        gap: 3rem;
        margin-bottom: 4rem;
    }

    /* Floating Animation */
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-15px); }
    }

    .metric-card:nth-child(1) { animation: float 8s ease-in-out infinite; }
    .metric-card:nth-child(2) { animation: float 8s ease-in-out infinite 2s; }
    .metric-card:nth-child(3) { animation: float 8s ease-in-out infinite 4s; }
    .metric-card:nth-child(4) { animation: float 8s ease-in-out infinite 6s; }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        .chart-grid {
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        .data-grid {
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        .metric-card {
            padding: 2rem;
        }
        
        .chart-container,
        .table-container {
            padding: 2rem;
        }
        
        .metric-value {
            font-size: 3.5rem;
        }
        
        .metric-icon {
            font-size: 3rem;
        }
    }

    /* Loading Animation */
    .loading-shimmer {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h2 mb-3">
                        <i class="fas fa-chart-line me-3"></i>
                        Analytics Dashboard
                        <span class="real-time-indicator" title="Real-time data"></span>
                    </h1>
                    <p class="mb-0 opacity-75 fs-5">Comprehensive insights into your website performance</p>
                </div>
                <div class="col-md-4">
                    <div class="d-flex gap-3">
                        <input type="date" class="form-control form-control-modern" id="startDate" value="{{ start_date|date:'Y-m-d' }}">
                        <input type="date" class="form-control form-control-modern" id="endDate" value="{{ end_date|date:'Y-m-d' }}">
                        <button class="btn btn-modern" onclick="updateDateRange()">
                            <i class="fas fa-filter me-2"></i>Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">

        <!-- Key Metrics -->
        <div class="stats-grid">
            <div class="metric-card">
                <i class="fas fa-users metric-icon"></i>
                <div class="metric-value">{{ total_visitors|floatformat:0 }}</div>
                <div class="metric-label">Total Visitors</div>
                <div class="metric-trend trend-up">
                    <i class="fas fa-arrow-up me-2"></i>+12% from last period
                </div>
            </div>
            <div class="metric-card">
                <i class="fas fa-user-friends metric-icon"></i>
                <div class="metric-value">{{ unique_visitors|floatformat:0 }}</div>
                <div class="metric-label">Unique Visitors</div>
                <div class="metric-trend trend-up">
                    <i class="fas fa-arrow-up me-2"></i>+8% from last period
                </div>
            </div>
            <div class="metric-card">
                <i class="fas fa-eye metric-icon"></i>
                <div class="metric-value">{{ total_page_views|floatformat:0 }}</div>
                <div class="metric-label">Page Views</div>
                <div class="metric-trend trend-up">
                    <i class="fas fa-arrow-up me-2"></i>+15% from last period
                </div>
            </div>
            <div class="metric-card">
                <i class="fas fa-chart-line metric-icon"></i>
                <div class="metric-value">{{ bounce_rate }}%</div>
                <div class="metric-label">Bounce Rate</div>
                <div class="metric-trend trend-down">
                    <i class="fas fa-arrow-down me-2"></i>-3% from last period
                </div>
            </div>
        </div>

        <!-- Real-time Stats -->
        <div class="chart-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <i class="fas fa-users chart-icon"></i>
                    <h5 class="chart-title">Real-time Visitors</h5>
                </div>
                <div class="text-center py-5">
                    <div class="display-1 fw-bold" style="background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                        {{ real_time_visitors }}
                    </div>
                    <p class="text-muted fs-4">Active in last 5 minutes</p>
                    <div class="d-flex justify-content-center align-items-center">
                        <span class="real-time-indicator"></span>
                        <span class="text-success fw-bold fs-5">Live Data</span>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <i class="fas fa-clock chart-icon"></i>
                    <h5 class="chart-title">Session Duration</h5>
                </div>
                <div class="text-center py-5">
                    <div class="display-1 fw-bold" style="background: var(--success-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                        {% if avg_duration %}
                            {{ avg_duration|floatformat:0 }}s
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <p class="text-muted fs-4">Average time per session</p>
                    <div class="mt-4">
                        <span class="badge badge-success fs-6">Good Engagement</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="chart-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <i class="fas fa-chart-bar chart-icon"></i>
                    <h5 class="chart-title">Hourly Traffic Distribution</h5>
                </div>
                <div style="position: relative; height: 350px;">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <i class="fas fa-mobile-alt chart-icon"></i>
                    <h5 class="chart-title">Device Breakdown</h5>
                </div>
                <div style="position: relative; height: 350px;">
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Tables Row -->
        <div class="data-grid">
            <div class="table-container">
                <div class="table-header">
                    <i class="fas fa-globe me-3"></i>
                    Traffic Sources
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Visitors</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for source in traffic_sources %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{% if source.source_type == 'google' %}search{% elif source.source_type == 'facebook' %}facebook{% elif source.source_type == 'whatsapp' %}whatsapp{% elif source.source_type == 'direct' %}home{% else %}link{% endif %} me-3 text-primary"></i>
                                        <span class="fw-bold">{{ source.source_name }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-primary">{{ source.visitors }}</span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 12px; width: 120px;">
                                        <div class="progress-bar" style="width: {{ source.percentage }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ source.percentage }}%</small>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted py-5">
                                    <i class="fas fa-chart-pie fa-3x mb-3"></i>
                                    <p class="fs-5">No traffic sources data available</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <i class="fas fa-file-alt me-3"></i>
                    Top Pages
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Page</th>
                                <th>Views</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in top_pages %}
                            <tr>
                                <td>
                                    <a href="{{ page.path }}" class="text-decoration-none fw-bold">
                                        {{ page.page_title|default:page.path|truncatechars:30 }}
                                    </a>
                                </td>
                                <td>
                                    <span class="badge badge-success">{{ page.views }}</span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 12px; width: 120px;">
                                        <div class="progress-bar bg-success" style="width: {{ page.percentage }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ page.percentage }}%</small>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted py-5">
                                    <i class="fas fa-file-alt fa-3x mb-3"></i>
                                    <p class="fs-5">No page data available</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Geographic & Browser Data -->
        <div class="data-grid">
            <div class="table-container">
                <div class="table-header">
                    <i class="fas fa-map-marker-alt me-3"></i>
                    Top Countries
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Country</th>
                                <th>Visitors</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for country in country_breakdown %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-globe me-3 text-info"></i>
                                        <span class="fw-bold">{{ country.country }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-primary">{{ country.count }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center text-muted py-5">
                                    <i class="fas fa-globe fa-3x mb-3"></i>
                                    <p class="fs-5">No geographic data available</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <i class="fas fa-desktop me-3"></i>
                    Browser Breakdown
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Browser</th>
                                <th>Visitors</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for browser in browser_breakdown %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-globe me-3 text-warning"></i>
                                        <span class="fw-bold">{{ browser.browser }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-warning">{{ browser.count }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center text-muted py-5">
                                    <i class="fas fa-desktop fa-3x mb-3"></i>
                                    <p class="fs-5">No browser data available</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Visitors -->
        <div class="table-container">
            <div class="table-header">
                <i class="fas fa-eye me-3"></i>
                Recent Visitors
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Visitor ID</th>
                            <th>Location</th>
                            <th>Device</th>
                            <th>Browser</th>
                            <th>Last Visit</th>
                            <th>Page Views</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for visitor in recent_visitors %}
                        <tr>
                            <td>
                                <a href="{% url 'analytics:visitor_detail' visitor.visitor_id %}" class="text-decoration-none fw-bold">
                                    {{ visitor.visitor_id|truncatechars:8 }}
                                </a>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-map-marker-alt me-2 text-danger"></i>
                                    <span>
                                        {% if visitor.city and visitor.country %}
                                            {{ visitor.city }}, {{ visitor.country }}
                                        {% else %}
                                            {{ visitor.country|default:"Unknown" }}
                                        {% endif %}
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-{% if visitor.device_type == 'mobile' %}mobile-alt{% elif visitor.device_type == 'tablet' %}tablet-alt{% else %}desktop{% endif %} me-2 text-info"></i>
                                    <span class="fw-bold">{{ visitor.device_type|title }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="badge badge-info">{{ visitor.browser }}</span>
                            </td>
                            <td>
                                <small class="text-muted">{{ visitor.last_visit|timesince }} ago</small>
                            </td>
                            <td>
                                <span class="badge badge-success">{{ visitor.total_page_views }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-5">
                                <i class="fas fa-users fa-3x mb-3"></i>
                                <p class="fs-5">No recent visitors data available</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Ultra-Modern Chart Configuration
Chart.defaults.font.family = "'Inter', 'Poppins', sans-serif";
Chart.defaults.color = '#64748b';
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.padding = 20;

// Hourly Traffic Chart
const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
const hourlyData = JSON.parse('{{ hourly_data|escapejs }}');

new Chart(hourlyCtx, {
    type: 'line',
    data: {
        labels: hourlyData.map(item => item.hour + ':00'),
        datasets: [{
            label: 'Page Views',
            data: hourlyData.map(item => item.count),
            borderColor: 'rgba(102, 126, 234, 1)',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 4,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: 'rgba(102, 126, 234, 1)',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 3,
            pointRadius: 8,
            pointHoverRadius: 12,
            pointHoverBackgroundColor: 'rgba(102, 126, 234, 1)',
            pointHoverBorderColor: '#ffffff',
            pointHoverBorderWidth: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 2,
                cornerRadius: 12,
                displayColors: false,
                titleFont: {
                    size: 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 13,
                    weight: '600'
                }
            }
        },
        scales: {
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#64748b',
                    font: {
                        size: 12,
                        weight: '600'
                    }
                }
            },
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)',
                    drawBorder: false
                },
                ticks: {
                    color: '#64748b',
                    font: {
                        size: 12,
                        weight: '600'
                    }
                }
            }
        },
        elements: {
            point: {
                hoverBackgroundColor: 'rgba(102, 126, 234, 1)'
            }
        }
    }
});

// Device Breakdown Chart
const deviceCtx = document.getElementById('deviceChart').getContext('2d');
const deviceData = JSON.parse('{{ device_breakdown_json|escapejs }}');

new Chart(deviceCtx, {
    type: 'doughnut',
    data: {
        labels: deviceData.map(item => item.device_type),
        datasets: [{
            data: deviceData.map(item => item.count),
            backgroundColor: [
                'rgba(102, 126, 234, 0.9)',
                'rgba(16, 185, 129, 0.9)',
                'rgba(245, 158, 11, 0.9)',
                'rgba(239, 68, 68, 0.9)',
                'rgba(139, 92, 246, 0.9)'
            ],
            borderColor: [
                'rgba(102, 126, 234, 1)',
                'rgba(16, 185, 129, 1)',
                'rgba(245, 158, 11, 1)',
                'rgba(239, 68, 68, 1)',
                'rgba(139, 92, 246, 1)'
            ],
            borderWidth: 3,
            hoverOffset: 15
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 25,
                    usePointStyle: true,
                    pointStyle: 'circle',
                    font: {
                        size: 13,
                        weight: '700'
                    },
                    color: '#1e293b'
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 2,
                cornerRadius: 12,
                displayColors: true,
                titleFont: {
                    size: 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 13,
                    weight: '600'
                },
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                        return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                    }
                }
            }
        },
        cutout: '65%',
        elements: {
            arc: {
                borderWidth: 0
            }
        }
    }
});

// Update date range
function updateDateRange() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const url = new URL(window.location);
    url.searchParams.set('start_date', startDate);
    url.searchParams.set('end_date', endDate);
    window.location.href = url.toString();
}

// Enhanced auto-refresh with loading states
let refreshInterval;

function startAutoRefresh() {
    refreshInterval = setInterval(function() {
        // Add loading animation
        const realTimeIndicator = document.querySelector('.real-time-indicator');
        if (realTimeIndicator) {
            realTimeIndicator.style.animation = 'none';
            setTimeout(() => {
                realTimeIndicator.style.animation = 'pulse 2s infinite';
            }, 100);
        }
        
        // Fetch updated data
        fetch('{% url "analytics:api" %}?metric=overview&period=30d')
            .then(response => response.json())
            .then(data => {
                // Update real-time visitor count
                if (data.real_time_visitors !== undefined) {
                    const realTimeElement = document.querySelector('.real-time-indicator').parentElement.querySelector('.display-1');
                    if (realTimeElement) {
                        realTimeElement.textContent = data.real_time_visitors;
                    }
                }
            })
            .catch(error => console.log('Auto-refresh error:', error));
    }, 30000);
}

// Start auto-refresh
startAutoRefresh();

// Add smooth animations to metric cards
document.addEventListener('DOMContentLoaded', function() {
    const metricCards = document.querySelectorAll('.metric-card');
    metricCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        setTimeout(() => {
            card.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 150);
    });
    
    // Add hover effects to table rows
    const tableRows = document.querySelectorAll('.table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(8px)';
            this.style.transition = 'transform 0.3s ease';
        });
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
        });
    });
});
</script>
{% endblock %}