{% extends 'crm/base.html' %}
{% load static %}

{% block page_title %}{% if object %}Edit Patient{% else %}Add New Patient{% endif %}{% endblock %}
{% block page_description %}{% if object %}Update patient information{% else %}Register a new patient{% endif %}{% endblock %}

{% block crm_content %}
<div class="max-w-4xl mx-auto">
    <div class="crm-card group">
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-blue-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-r from-medical-blue to-medical-aqua rounded-full flex items-center justify-center">
                        <i class="fas fa-user-plus text-white text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center space-x-2">
                            <span>{% if object %}Edit Patient{% else %}Add New Patient{% endif %}</span>
                            <div class="w-2 h-2 bg-gradient-to-r from-medical-blue to-medical-aqua rounded-full crm-pulse"></div>
                        </h2>
                        <p class="text-gray-600 flex items-center space-x-2">
                            <i class="fas fa-info-circle text-medical-blue"></i>
                            <span>{% if object %}Update patient information{% else %}Register a new patient in the system{% endif %}</span>
                        </p>
                    </div>
                </div>
                <a href="{% url 'crm:patient_list' %}" class="text-gray-500 hover:text-gray-700 transition-colors duration-300 hover:scale-110">
                    <i class="fas fa-times text-xl"></i>
                </a>
            </div>
        </div>
        
        <form method="post" class="p-6" x-data="{ 
            formData: {},
            errors: {},
            isSubmitting: false,
            validateField(fieldName, value) {
                const rules = {
                    first_name: { required: true, minLength: 2 },
                    last_name: { required: true, minLength: 2 },
                    phone: { required: true, pattern: /^[0-9]{10}$/ },
                    email: { pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
                    date_of_birth: { required: true }
                };
                
                const rule = rules[fieldName];
                if (!rule) return true;
                
                if (rule.required && !value) {
                    this.errors[fieldName] = 'This field is required';
                    return false;
                }
                
                if (rule.minLength && value.length < rule.minLength) {
                    this.errors[fieldName] = `Minimum ${rule.minLength} characters required`;
                    return false;
                }
                
                if (rule.pattern && value && !rule.pattern.test(value)) {
                    this.errors[fieldName] = 'Invalid format';
                    return false;
                }
                
                delete this.errors[fieldName];
                return true;
            }
        }">
            {% csrf_token %}
            
            <!-- Progress Indicator -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Form Progress</h3>
                    <span class="text-sm text-gray-600">Step 1 of 5</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-gradient-to-r from-medical-blue to-medical-aqua h-2 rounded-full transition-all duration-300" style="width: 20%"></div>
                </div>
            </div>
            
            <!-- Basic Information -->
            <div class="mb-8">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-8 h-8 bg-gradient-to-r from-medical-blue to-medical-aqua rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white text-sm"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">Basic Information</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="form-group">
                        <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-user mr-2 text-medical-blue"></i>
                            First Name *
                        </label>
                        <div class="relative">
                            {{ form.first_name|add_class:"crm-form-input w-full" }}
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <i class="fas fa-check text-green-500 opacity-0 transition-opacity duration-300" x-show="!errors.first_name && formData.first_name"></i>
                                <i class="fas fa-exclamation-triangle text-red-500 opacity-0 transition-opacity duration-300" x-show="errors.first_name"></i>
                            </div>
                        </div>
                        <p class="mt-1 text-sm text-red-600" x-show="errors.first_name" x-text="errors.first_name"></p>
                        {% if form.first_name.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.first_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-user mr-2 text-medical-blue"></i>
                            Last Name *
                        </label>
                        <div class="relative">
                            {{ form.last_name|add_class:"crm-form-input w-full" }}
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <i class="fas fa-check text-green-500 opacity-0 transition-opacity duration-300" x-show="!errors.last_name && formData.last_name"></i>
                                <i class="fas fa-exclamation-triangle text-red-500 opacity-0 transition-opacity duration-300" x-show="errors.last_name"></i>
                            </div>
                        </div>
                        <p class="mt-1 text-sm text-red-600" x-show="errors.last_name" x-text="errors.last_name"></p>
                        {% if form.last_name.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.last_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.middle_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-user mr-2 text-gray-400"></i>
                            Middle Name
                        </label>
                        <div class="relative">
                            {{ form.middle_name|add_class:"crm-form-input w-full" }}
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <i class="fas fa-check text-green-500 opacity-0 transition-opacity duration-300" x-show="formData.middle_name"></i>
                            </div>
                        </div>
                        {% if form.middle_name.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.middle_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="{{ form.date_of_birth.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Date of Birth *</label>
                        {{ form.date_of_birth }}
                        {% if form.date_of_birth.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.date_of_birth.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.gender.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Gender *</label>
                        {{ form.gender }}
                        {% if form.gender.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.gender.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Contact Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.phone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                        {{ form.phone }}
                        {% if form.phone.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.phone.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mt-4">
                    <label for="{{ form.address.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Address *</label>
                    {{ form.address }}
                    {% if form.address.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.address.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label for="{{ form.city.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                        {{ form.city }}
                        {% if form.city.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.city.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.state.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">State *</label>
                        {{ form.state }}
                        {% if form.state.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.state.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.pincode.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Pincode *</label>
                        {{ form.pincode }}
                        {% if form.pincode.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.pincode.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Emergency Contact -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Emergency Contact</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="{{ form.emergency_contact_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Contact Name</label>
                        {{ form.emergency_contact_name }}
                        {% if form.emergency_contact_name.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.emergency_contact_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.emergency_contact_phone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Contact Phone</label>
                        {{ form.emergency_contact_phone }}
                        {% if form.emergency_contact_phone.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.emergency_contact_phone.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.emergency_contact_relation.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Relation</label>
                        {{ form.emergency_contact_relation }}
                        {% if form.emergency_contact_relation.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.emergency_contact_relation.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Medical Information -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Medical Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="{{ form.blood_group.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Blood Group</label>
                        {{ form.blood_group }}
                        {% if form.blood_group.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.blood_group.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.height.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Height (cm)</label>
                        {{ form.height }}
                        {% if form.height.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.height.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.weight.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Weight (kg)</label>
                        {{ form.weight }}
                        {% if form.weight.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.weight.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mt-4">
                    <label for="{{ form.allergies.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Allergies</label>
                    {{ form.allergies }}
                    {% if form.allergies.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.allergies.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div class="mt-4">
                    <label for="{{ form.medical_history.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Medical History</label>
                    {{ form.medical_history }}
                    {% if form.medical_history.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.medical_history.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div class="mt-4">
                    <label for="{{ form.current_medications.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Current Medications</label>
                    {{ form.current_medications }}
                    {% if form.current_medications.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.current_medications.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Insurance Information -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Insurance Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="{{ form.insurance_provider.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Insurance Provider</label>
                        {{ form.insurance_provider }}
                        {% if form.insurance_provider.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.insurance_provider.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.insurance_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Insurance Number</label>
                        {{ form.insurance_number }}
                        {% if form.insurance_number.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.insurance_number.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.insurance_validity.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Validity Date</label>
                        {{ form.insurance_validity }}
                        {% if form.insurance_validity.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.insurance_validity.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        All fields marked with * are required
                    </div>
                </div>
                <div class="flex space-x-4">
                    <a href="{% url 'crm:patient_list' %}" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-300 hover:scale-105 flex items-center group">
                        <i class="fas fa-times mr-2 group-hover:rotate-90 transition-transform duration-300"></i>
                        Cancel
                    </a>
                    <button type="submit" 
                            class="crm-button text-white px-8 py-3 rounded-lg hover:shadow-lg transition-all duration-300 hover:scale-105 flex items-center group"
                            :disabled="isSubmitting"
                            @click="isSubmitting = true">
                        <span class="relative z-10 flex items-center">
                            <i class="fas fa-save mr-2 group-hover:rotate-12 transition-transform duration-300" x-show="!isSubmitting"></i>
                            <div class="crm-loading mr-2" x-show="isSubmitting"></div>
                            <span x-text="isSubmitting ? 'Saving...' : '{% if object %}Update Patient{% else %}Add Patient{% endif %}'"></span>
                        </span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Success Modal -->
<div x-data="{ showSuccess: false }" x-show="showSuccess" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
        <div class="text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-green-600 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Success!</h3>
            <p class="text-gray-600 mb-4">Patient has been {% if object %}updated{% else %}added{% endif %} successfully.</p>
            <button @click="showSuccess = false" class="crm-button text-white px-6 py-2 rounded-lg">
                Continue
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Enhanced form validation
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('form');
        const inputs = form.querySelectorAll('input, textarea, select');
        
        inputs.forEach(input => {
            // Real-time validation
            input.addEventListener('input', (e) => {
                const fieldName = e.target.name;
                const value = e.target.value;
                
                // Remove existing validation classes
                e.target.classList.remove('border-red-500', 'border-green-500');
                
                // Basic validation
                if (e.target.hasAttribute('required') && !value) {
                    e.target.classList.add('border-red-500');
                } else if (value) {
                    e.target.classList.add('border-green-500');
                }
            });
            
            // Focus effects
            input.addEventListener('focus', (e) => {
                e.target.parentElement.classList.add('ring-2', 'ring-medical-blue', 'ring-opacity-50');
            });
            
            input.addEventListener('blur', (e) => {
                e.target.parentElement.classList.remove('ring-2', 'ring-medical-blue', 'ring-opacity-50');
            });
        });
        
        // Form submission
        form.addEventListener('submit', (e) => {
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="crm-loading mr-2"></div>Saving...';
        });
    });
    
    // Auto-save functionality (optional)
    function autoSave() {
        const formData = new FormData(document.querySelector('form'));
        // Implement auto-save logic here
        console.log('Auto-saving form data...');
    }
    
    // Auto-save every 30 seconds
    setInterval(autoSave, 30000);
</script>
{% endblock %}
